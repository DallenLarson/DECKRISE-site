<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Decklist Converter</title>
  <style>
    body {
      background: #0f0f0f;
      color: #fff;
      font-family: monospace;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 300px;
      background: #1a1a1a;
      color: #0f0;
      border: 1px solid #333;
      padding: 10px;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-weight: bold;
      background: #00cccc;
      color: #000;
      border: none;
      cursor: pointer;
    }
    pre {
      background: #111;
      color: #0f0;
      padding: 1em;
      white-space: pre-wrap;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>PTCGL Decklist to API JSON Converter</h1>
  <textarea id="deck-import" placeholder="Paste your PTCGL decklist here..."></textarea><br/>
  <button onclick="convertDecklist()">Convert & Copy</button>
  <pre id="parsed-output"></pre>

  <h1 style="margin-top: 40px;">API JSON to PTCGL Decklist Converter</h1>
  <textarea id="json-import" placeholder="Paste your API JSON cardList here (just the cardList part)..."></textarea><br/>
  <button id="convert-btn">Convert & Copy</button>
  <pre id="ptcgl-output"></pre>

  <script>
    const API_KEY = "7e56dabe-1394-4d6e-aa3b-f7250070b899";

    const setMap = {
      "SVE": "sve",
      "SVI": "sv1",
      "PAL": "sv2",
      "OBF": "sv3",
      "PAR": "sv4",
      "TEF": "sv5",
      "TWM": "sv6",
      "MEW": "sv3pt5",
      "SFA": "sv6pt5",
      "SCR": "sv7",
      "PRE": "sv8pt5",
      "JTG": "sv9",
      "SSP": "sv8",
      "DRI": "sv10",
      "BLK": "sv11",
      "WHT": "sv12"
    };

    const reverseSetMap = Object.fromEntries(
      Object.entries(setMap).map(([k, v]) => [v, k])
    );

    function convertDecklist() {
      const input = document.getElementById("deck-import").value.trim();
      const lines = input.split("\n");

      const output = { pokemon: [], trainer: [], energy: [] };
      let current = null;

      for (const line of lines) {
        const trimmed = line.trim();
        if (trimmed.toLowerCase().startsWith("pokémon")) current = "pokemon";
        else if (trimmed.toLowerCase().startsWith("trainer")) current = "trainer";
        else if (trimmed.toLowerCase().startsWith("energy")) current = "energy";
        else if (/^\d+ /.test(trimmed)) {
          const parts = trimmed.split(" ");
          const count = parseInt(parts[0]);
          const number = parts.pop();
          const setCode = parts.pop().toUpperCase();
          const name = parts.slice(1).join(" ");
          const set = setMap[setCode] || setCode.toLowerCase();
          output[current].push({ count, set, number, name });
        }
      }

      function formatSection(title, cards) {
        return [
          `  ${title}: [`,
          ...cards.map(card =>
            `    { count: ${card.count}, set: "${card.set}", number: "${card.number}" }, // ${card.name}`
          ),
          `  ],`
        ].join("\n");
      }

      const formatted = [
        "cardList: {",
        formatSection("pokemon", output.pokemon),
        formatSection("trainer", output.trainer),
        formatSection("energy", output.energy).replace(/,\s*$/, ""),
        "}"
      ].join("\n");

      document.getElementById("parsed-output").textContent = formatted;
      navigator.clipboard.writeText(formatted).then(() => {
        alert("✅ Converted and copied to clipboard!");
      });
    }

    async function convertToPTCGL() {
      console.log("🚀 Starting convertToPTCGL()");
      const input = document.getElementById("json-import").value.trim();

      let wrapped;
      try {
        if (input.startsWith("cardList:")) {
          console.log("📦 Wrapping as object");
          wrapped = eval("({" + input + "})");
        } else {
          console.log("📦 Parsing as full object");
          wrapped = eval("(" + input + ")");
        }
      } catch (e) {
        console.error("❌ Failed to parse input:", e);
        alert("❌ Error parsing input. Make sure it's valid JavaScript object syntax.");
        return;
      }

      const deck = wrapped.cardList || wrapped;
      console.log("✅ Parsed deck:", deck);

      const sections = ["pokemon", "trainer", "energy"];
      const cardNameCache = {};

      async function getCardName(set, number) {
        const cacheKey = `${set}-${number}`;
        if (cardNameCache[cacheKey]) {
          console.log(`📁 Using cached name for ${cacheKey}`);
          return cardNameCache[cacheKey];
        }

        try {
          console.log(`🌐 Fetching ${set} ${number}`);
          const response = await fetch(`https://api.pokemontcg.io/v2/cards?q=set.id:${set}+number:${number}`, {
            headers: { "X-Api-Key": API_KEY }
          });
          const data = await response.json();
          const cardName = data.data[0]?.name || "???";
          console.log(`🔠 Got name: ${cardName}`);
          cardNameCache[cacheKey] = cardName;
          return cardName;
        } catch (err) {
          console.error(`❌ Error fetching ${set} ${number}:`, err);
          return "???";
        }
      }

      let result = "";
      for (const section of sections) {
        if (deck[section]?.length) {
          console.log(`📂 Section: ${section}`);
          result += section.charAt(0).toUpperCase() + section.slice(1) + ":\n";
          for (const card of deck[section]) {
            console.log(`🔍 Processing card:`, card);
            const count = card.count;
            const setCode = reverseSetMap[card.set.toUpperCase()] || card.set.toUpperCase();
            const name = await getCardName(card.set.toLowerCase(), card.number);
            result += `${count} ${name} ${setCode} ${card.number}\n`;
          }
          result += "\n";
        } else {
          console.warn(`⚠️ No cards in section ${section}`);
        }
      }

      console.log("✅ Final Output:\n", result);
      document.getElementById("ptcgl-output").textContent = result.trim();

      try {
        await navigator.clipboard.writeText(result.trim());
        alert("✅ Converted and copied to clipboard!");
      } catch (copyErr) {
        console.error("❌ Clipboard error:", copyErr);
        alert("✅ Converted but could not copy to clipboard.");
      }
    }

    // Hook up button listener for async function
    document.getElementById("convert-btn").addEventListener("click", () => {
      convertToPTCGL();
    });
  </script>
</body>
</html>
